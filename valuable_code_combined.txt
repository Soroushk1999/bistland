

# ===== File: config/__init__.py =====


from .celery import app as celery_app

# ===== File: config/asgi.py =====


"""
ASGI config for config project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_asgi_application()


# ===== File: config/celery.py =====


import os
from celery import Celery

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "config.settings")

app = Celery("config")
app.config_from_object("django.conf:settings", namespace="CELERY")
app.autodiscover_tasks()





# ===== File: config/settings.py =====


from pathlib import Path
import os


BASE_DIR = Path(__file__).resolve().parent.parent

SECRET_KEY = os.environ.get("DJANGO_SECRET_KEY", "dev-secret-key-change-me")

DEBUG = os.environ.get("DJANGO_DEBUG", "1") == "1"

ALLOWED_HOSTS: list[str] = [
    "*" if DEBUG else os.environ.get("DJANGO_ALLOWED_HOST", "localhost"),
]

INSTALLED_APPS = [
    # Default
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",

    # Dependencies
    "django_prometheus",
    "rest_framework",
    "drf_spectacular",

    # Custom apps
    "landing.apps.LandingConfig",
]

MIDDLEWARE = [
    "django_prometheus.middleware.PrometheusBeforeMiddleware",
    "django.middleware.security.SecurityMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
    "django_prometheus.middleware.PrometheusAfterMiddleware",
]

ROOT_URLCONF = "config.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [BASE_DIR / "templates"],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.debug",
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    }
]

WSGI_APPLICATION = "config.wsgi.application"
ASGI_APPLICATION = "config.asgi.application"

default_engine = os.environ.get("DB_ENGINE", "django.db.backends.sqlite3")
if default_engine == "django.db.backends.postgresql":
    default_engine = "django_prometheus.db.backends.postgresql"

DATABASES = {
    "default": {
        "ENGINE": default_engine,
        "NAME": os.environ.get("DB_NAME", str(BASE_DIR / "db.sqlite3")),
        "USER": os.environ.get("DB_USER", ""),
        "PASSWORD": os.environ.get("DB_PASSWORD", ""),
        "HOST": os.environ.get("DB_HOST", ""),
        "PORT": os.environ.get("DB_PORT", ""),
    }
}

CACHES = {
    "default": {
        "BACKEND": os.environ.get(
            "CACHE_BACKEND",
            "django.core.cache.backends.locmem.LocMemCache",
        ),
        "LOCATION": os.environ.get("CACHE_LOCATION", "landing-cache"),
        "TIMEOUT": None,
    }
}

# Celery
CELERY_BROKER_URL = os.environ.get("CELERY_BROKER_URL", os.environ.get("REDIS_URL", "redis://redis:6379/0"))
CELERY_RESULT_BACKEND = os.environ.get("CELERY_RESULT_BACKEND", os.environ.get("REDIS_URL", "redis://redis:6379/0"))
CELERY_TASK_ALWAYS_EAGER = os.environ.get("CELERY_EAGER", "0") == "1"
CELERY_TASK_TIME_LIMIT = 30
CELERY_TASK_SOFT_TIME_LIMIT = 20

LANGUAGE_CODE = "en-us"
TIME_ZONE = "UTC"
USE_I18N = True
USE_TZ = True

STATIC_URL = "/static/"
STATIC_ROOT = BASE_DIR / "staticfiles"
STATICFILES_DIRS = [BASE_DIR / "static"]

# MinIO / S3 Storage for Media Files
USE_MINIO = os.environ.get("USE_MINIO", "1") == "1"
MINIO_ENDPOINT = os.environ.get("MINIO_ENDPOINT", "minio:9000")
MINIO_PUBLIC_URL = os.environ.get("MINIO_PUBLIC_URL", "http://localhost:9000")  # For browser access
MINIO_ACCESS_KEY = os.environ.get("MINIO_ACCESS_KEY", "minioadmin")
MINIO_SECRET_KEY = os.environ.get("MINIO_SECRET_KEY", "minioadmin")
MINIO_BUCKET_NAME = os.environ.get("MINIO_BUCKET_NAME", "landing-media")
MINIO_USE_HTTPS = os.environ.get("MINIO_USE_HTTPS", "0") == "1"

if USE_MINIO:
    # MinIO Storage Settings (internal endpoint for Django)
    AWS_ACCESS_KEY_ID = MINIO_ACCESS_KEY
    AWS_SECRET_ACCESS_KEY = MINIO_SECRET_KEY
    AWS_STORAGE_BUCKET_NAME = MINIO_BUCKET_NAME
    AWS_S3_ENDPOINT_URL = f"{'https' if MINIO_USE_HTTPS else 'http'}://{MINIO_ENDPOINT}"
    AWS_S3_USE_SSL = MINIO_USE_HTTPS
    AWS_S3_VERIFY = False
    AWS_DEFAULT_ACL = "public-read"
    AWS_S3_OBJECT_PARAMETERS = {
        "CacheControl": "max-age=86400",
    }
    DEFAULT_FILE_STORAGE = "storages.backends.s3boto3.S3Boto3Storage"
    # Use public URL for MEDIA_URL so browser can access it
    MEDIA_URL = f"{MINIO_PUBLIC_URL}/{MINIO_BUCKET_NAME}/"
else:
    MEDIA_URL = "/media/"
    MEDIA_ROOT = BASE_DIR / "media"

DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

SECURE_PROXY_SSL_HEADER = ("HTTP_X_FORWARDED_PROTO", "https")


# Django REST Framework
REST_FRAMEWORK = {
    "DEFAULT_RENDERER_CLASSES": [
        "rest_framework.renderers.JSONRenderer",
    ],
    "DEFAULT_PARSER_CLASSES": [
        "rest_framework.parsers.JSONParser",
        "rest_framework.parsers.FormParser",
    ],
    "DEFAULT_SCHEMA_CLASS": "drf_spectacular.openapi.AutoSchema",
    # "DEFAULT_THROTTLE_RATES": {
    #     "submit_ip": os.environ.get("DRF_THROTTLE_SUBMIT", "20/min"),
    # },
}

SPECTACULAR_SETTINGS = {
    "TITLE": "Landing Page Submission API",
    "DESCRIPTION": "API documentation for the high-traffic landing page submission service.",
    "VERSION": "1.0.0",
    "SERVE_INCLUDE_SCHEMA": False,
}



# ===== File: config/urls.py =====


from django.contrib import admin
from django.urls import include, path
from django.views.decorators.cache import cache_page
from rest_framework.views import APIView
from rest_framework.response import Response
from drf_spectacular.views import SpectacularAPIView, SpectacularSwaggerView, SpectacularRedocView


class HealthzView(APIView):
    authentication_classes = []
    permission_classes = []

    def get(self, _request):
        return Response({"status": "ok"})


urlpatterns = [
    path("admin/", admin.site.urls),
    path("healthz", HealthzView.as_view(), name="healthz"),
    path("api/schema", SpectacularAPIView.as_view(), name="schema"),
    path(
        "api/swagger",
        SpectacularSwaggerView.as_view(url_name="schema"),
        name="swagger-ui",
    ),
    path(
        "api/redoc",
        SpectacularRedocView.as_view(url_name="schema"),
        name="redoc",
    ),
    path("", include("django_prometheus.urls"), name="metrics"),
    path("", include("landing.urls"), name="landing"),
]




# ===== File: config/wsgi.py =====


"""
WSGI config for config project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')

application = get_wsgi_application()


# ===== File: landing/__init__.py =====




# ===== File: landing/admin.py =====


from django.contrib import admin
from .models import Phone


@admin.register(Phone)
class PhoneAdmin(admin.ModelAdmin):
    list_display = ("id", "phone", "created_at")
    search_fields = ("phone",)
    list_filter = ("created_at",)





# ===== File: landing/apis/__init__.py =====


from .submit_phone_apis import SubmitPhoneView
from .landing_apis import LandingPageView




# ===== File: landing/apis/landing_apis.py =====


from django.conf import settings
from django.utils.decorators import method_decorator
from django.views.decorators.cache import cache_page
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import AllowAny
from rest_framework.renderers import JSONRenderer, TemplateHTMLRenderer

# Cache duration in seconds
CACHE_TTL = 60

@method_decorator(cache_page(CACHE_TTL), name='dispatch')
class LandingPageView(APIView):
    """
    Landing page endpoint:
    - Renders 'landing.html' for browsers
    - Returns JSON for API clients
    - Cached for 60 seconds
    """
    permission_classes = [AllowAny]
    renderer_classes = [TemplateHTMLRenderer, JSONRenderer]  # HTML + JSON

    template_name = "landing.html"

    def get(self, request, format=None):
        context = {
            "media_url": getattr(settings, "MEDIA_URL", "/media/"),
            "minio_enabled": getattr(settings, "USE_MINIO", False),
        }

        return Response(context)


# ===== File: landing/apis/submit_phone_apis.py =====


import time
import logging

from django.core.cache import cache
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from drf_spectacular.utils import extend_schema_view

from landing.tasks import save_phone_in_sql_task, log_request_in_mongo_task
from landing.serializers import SubmitPhoneSerializer
from landing.schemas.submit_phone_schemas import SubmitPhoneSchema
from landing.utils import get_client_ip
from landing.throttles import SubmitPerIPThrottle  
from landing.metrics import endpoint_latency, endpoint_requests


logger = logging.getLogger(__name__)


@extend_schema_view(
    post=SubmitPhoneSchema.post
)
class SubmitPhoneView(APIView):
    """
    API endpoint for submitting phone numbers.
    Handles deduplication, asynchronous persistence,
    request logging, and Prometheus metrics.
    """
    # throttle_classes = [SubmitPerIPThrottle]  # enable if rate-limiting is needed
    serializer_class = SubmitPhoneSerializer

    def post(self, request):
        start_time = time.perf_counter()
        ip = get_client_ip(request) or "unknown"
        
        try:
            serializer = self.serializer_class(data=request.data)
            serializer.is_valid(raise_exception=True)
            phone = serializer.validated_data["phone"]

            logger.info(f"ðŸ“¨ Received phone submission: {phone} from IP {ip}")

            # --- Deduplication logic ---
            dedup_key = f"dedup:phone:{phone}"
            is_new_submission = cache.add(dedup_key, "1", timeout=24 * 3600)

            # Log every request asynchronously in mongodb
            log_request_in_mongo_task.delay({
                "phone": phone,
                "path": request.path,
                "ip": ip,
                "ua": request.META.get("HTTP_USER_AGENT", ""),
                "duplicate": not is_new_submission,
            })

            # --- Handle duplicate ---
            if not is_new_submission:
                logger.info(f"âš ï¸ Duplicate phone detected: {phone}")
                return Response({"ok": True, "duplicate": True}, status=status.HTTP_200_OK)

            # --- save on postgresql ---
            save_phone_in_sql_task.delay(phone=phone)    
            logger.info(f"âœ… Phone submission queued successfully: {phone}")
            endpoint_requests.labels(status="success").inc()
            
            return Response(
                {"ok": True, "queued": True, "duplicate": False},
                status=status.HTTP_200_OK
            )
        
        except Exception as e:
            logger.exception(f"âŒ Error processing phone submission: {e}")
            endpoint_requests.labels(status="error").inc()
            return Response(
                {"error": str(e)},
                status=status.HTTP_500_INTERNAL_SERVER_ERROR
            )

        finally:
            duration = time.perf_counter() - start_time
            endpoint_latency.observe(duration)
            logger.info(f"â±ï¸ SubmitPhoneView duration: {duration:.3f}s (IP: {ip})")


        


# ===== File: landing/apps.py =====


from django.apps import AppConfig


class LandingConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'landing'


# ===== File: landing/metrics.py =====


from prometheus_client import Counter, Histogram

# Count requests by status
endpoint_requests = Counter(
    'endpoint_requests_total',
    'Total number of requests to the heavy endpoint',
    ['status']  # label to separate success/failure
)

# Measure response latency
endpoint_latency = Histogram(
    'endpoint_request_duration_seconds',
    'Request duration for the heavy endpoint'
)


# ===== File: landing/migrations/0001_initial.py =====


# Generated by Django 5.0.7 on 2025-11-09 16:01

from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='Phone',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('phone', models.CharField(db_index=True, max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
            ],
            options={
                'indexes': [models.Index(fields=['phone', 'created_at'], name='landing_pho_phone_91abf6_idx')],
            },
        ),
    ]


# ===== File: landing/migrations/__init__.py =====




# ===== File: landing/models/Phone.py =====


from django.db import models


class Phone(models.Model):
    phone = models.CharField(max_length=20, db_index=True)
    created_at = models.DateTimeField(auto_now_add=True, db_index=True)

    class Meta:
        indexes = [
            models.Index(fields=["phone", "created_at"]),
        ]

    def __str__(self) -> str:
        return f"phone({self.phone})"



# ===== File: landing/models/__init__.py =====


from .Phone import Phone





# ===== File: landing/mongo.py =====


import os
from pymongo import MongoClient


def _mongo_collection():
    mongo_uri = os.environ.get("MONGO_URI", "mongodb://mongo:27017")
    mongo_db = os.environ.get("MONGO_DB", "landing_logs")
    client = MongoClient(mongo_uri)
    return client[mongo_db][os.environ.get("MONGO_COLLECTION", "requests")]


# ===== File: landing/schemas/__init__.py =====






# ===== File: landing/schemas/submit_phone_schemas.py =====


from drf_spectacular.utils import extend_schema, OpenApiResponse, OpenApiExample
from rest_framework import status

from landing.serializers import SubmitPhoneSerializer


class SubmitPhoneSchema:
    """Schema for the Submit Phone API (Lead Capture)"""

    post = extend_schema(
        summary="Submit a phone number for lead registration",
        description=(
            "Accepts a phone number and queues it for lead processing. "
            "If the phone number has already been submitted within the past 24 hours, "
            "a duplicate response will be returned instead."
        ),
        request=SubmitPhoneSerializer,
        responses={
            status.HTTP_200_OK: OpenApiResponse(
                response=SubmitPhoneSerializer,
                description="The phone number has already been submitted within the last 24 hours.",
                examples=[
                    OpenApiExample(
                        "Duplicate",
                        value={
                            "ok": True,
                            "duplicate": True,
                        },
                    )
                ],
            ),
            status.HTTP_400_BAD_REQUEST: OpenApiResponse(
                response=SubmitPhoneSerializer,
                description="Invalid or incorrectly formatted phone number.",
                examples=[
                    OpenApiExample(
                        "Invalid phone",
                        value={
                            "ok": False,
                            "error": "invalid_phone",
                        },
                    )
                ],
            ),
            status.HTTP_429_TOO_MANY_REQUESTS: OpenApiResponse(
                response=SubmitPhoneSerializer,
                description="Too many requests from this IP (rate limit exceeded).",
                examples=[
                    OpenApiExample(
                        "Too many requests",
                        value={
                            "ok": False,
                            "error": "too_many_requests",
                        },
                    )
                ],
            ),
        },
        tags=["Leads"],
        operation_id="submitPhone",
    )


# ===== File: landing/serializers/__init__.py =====


from .phone_submission import SubmitPhoneSerializer

# ===== File: landing/serializers/phone_submission.py =====


import re
from rest_framework import serializers


PHONE_REGEX = re.compile(r"^\+?[0-9]{10,15}$")


class SubmitPhoneSerializer(serializers.Serializer):
    phone = serializers.CharField(max_length=20)

    def validate_phone(self, value: str) -> str:
        value = value.strip()
        if not PHONE_REGEX.match(value):
            raise serializers.ValidationError("invalid_phone")
        return value


# ===== File: landing/tasks.py =====


import os
from celery import shared_task
from django.utils import timezone

from .models import Phone
from .mongo import _mongo_collection


@shared_task
def save_phone_in_sql_task(phone):
    saved_phone = Phone.objects.create(phone=phone)
    return saved_phone.id


@shared_task
def log_request_in_mongo_task(meta: dict):
    meta = {**meta, "ts": timezone.now().isoformat()}
    _mongo_collection().insert_one(meta)


# ===== File: landing/throttles.py =====


from rest_framework.throttling import SimpleRateThrottle

from .utils import get_client_ip


class SubmitPerIPThrottle(SimpleRateThrottle):
    scope = "submit_ip"

    def get_cache_key(self, request, view):
        ip = get_client_ip(request)
        if not ip:
            return None
        return self.cache_format % {"scope": self.scope, "ident": ip}



# ===== File: landing/urls.py =====


from django.urls import path

from landing.apis import LandingPageView, SubmitPhoneView


urlpatterns = [
    path("", LandingPageView.as_view(), name="landing-page"),
    path("api/submit", SubmitPhoneView.as_view(), name="submit_phone"),
]





# ===== File: landing/utils.py =====


from django.http import HttpRequest


def get_client_ip(request: HttpRequest) -> str | None:
    xff = request.META.get("HTTP_X_FORWARDED_FOR")
    if xff:
        return xff.split(",")[0].strip()
    return request.META.get("REMOTE_ADDR")



# ===== File: grafana/dashboards/my_dashboard.json =====


{
  "id": null,
  "uid": "endpoint-monitor-dashboard",
  "title": "Endpoint Monitor â€“ Heavy Load Test",
  "tags": ["endpoint", "load", "latency", "success"],
  "timezone": "browser",
  "editable": true,
  "graphTooltip": 1,
  "panels": [
    {
      "id": 1,
      "gridPos": { "x": 0, "y": 0, "w": 12, "h": 6 },
      "type": "stat",
      "title": "Total Requests",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "sum(endpoint_requests_total)",
          "legendFormat": "total",
          "refId": "A"
        }
      ],
      "options": {
        "reduceOptions": {
          "values": false,
          "calcs": ["lastNotNull"]
        },
        "orientation": "auto",
        "textMode": "value"
      }
    },
    {
      "id": 2,
      "gridPos": { "x": 12, "y": 0, "w": 12, "h": 6 },
      "type": "stat",
      "title": "Success Rate",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "(sum(endpoint_requests_total{status=\"success\"}) / sum(endpoint_requests_total))*100",
          "legendFormat": "success_rate",
          "refId": "A"
        }
      ],
      "options": {
        "unit": "percent",
        "reduceOptions": {
          "calcs": ["lastNotNull"]
        }
      }
    },
    {
      "id": 3,
      "gridPos": { "x": 0, "y": 6, "w": 24, "h": 8 },
      "type": "graph",
      "title": "Requests Rate (per second)",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "rate(endpoint_requests_total[1m])",
          "legendFormat": "req/s",
          "refId": "A"
        }
      ],
      "options": {
        "tooltip": { "shared": true }
      }
    },
    {
      "id": 4,
      "gridPos": { "x": 0, "y": 14, "w": 24, "h": 8 },
      "type": "graph",
      "title": "Latency Distribution (Histogram)",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, rate(endpoint_request_duration_seconds_bucket[5m]))",
          "legendFormat": "p95 latency",
          "refId": "A"
        },
        {
          "expr": "histogram_quantile(0.50, rate(endpoint_request_duration_seconds_bucket[5m]))",
          "legendFormat": "p50 latency",
          "refId": "B"
        },
        {
          "expr": "histogram_quantile(0.99, rate(endpoint_request_duration_seconds_bucket[5m]))",
          "legendFormat": "p99 latency",
          "refId": "C"
        }
      ],
      "options": {
        "tooltip": { "shared": true },
        "yaxes": [
          { "format": "s", "label": "seconds" },
          { "format": "short" }
        ]
      }
    },
    {
      "id": 5,
      "gridPos": { "x": 0, "y": 22, "w": 24, "h": 6 },
      "type": "table",
      "title": "Error Breakdown by Status",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "sum by(status) (endpoint_requests_total{status!=\"success\"})",
          "legendFormat": "{{status}}",
          "refId": "A"
        }
      ],
      "options": { "showHeader": true }
    },
    {
      "id": 6,
      "gridPos": { "x": 0, "y": 28, "w": 24, "h": 8 },
      "type": "timeseries",
      "title": "Latency Over Time (p50, p95, p99)",
      "datasource": "Prometheus",
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum(rate(endpoint_request_duration_seconds_bucket[1m])) by (le))",
          "legendFormat": "p50 latency",
          "refId": "A"
        },
        {
          "expr": "histogram_quantile(0.95, sum(rate(endpoint_request_duration_seconds_bucket[1m])) by (le))",
          "legendFormat": "p95 latency",
          "refId": "B"
        },
        {
          "expr": "histogram_quantile(0.99, sum(rate(endpoint_request_duration_seconds_bucket[1m])) by (le))",
          "legendFormat": "p99 latency",
          "refId": "C"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3,
          "custom": {
            "drawStyle": "lines",
            "lineWidth": 2,
            "fillOpacity": 10,
            "showPoints": "never"
          }
        }
      },
      "options": {
        "legend": {
          "displayMode": "table",
          "placement": "bottom"
        },
        "tooltip": { "mode": "multi" }
      }
    }
  ],
  "time": { "from": "now-30m", "to": "now" },
  "refresh": "10s",
  "schemaVersion": 27,
  "version": 2
}


# ===== File: grafana/provisioning/dashboards/dashboards.yaml =====


apiVersion: 1
providers:
  - name: 'Default'
    orgId: 1
    folder: ''
    type: file
    options:
      path: /var/lib/grafana/dashboards


# ===== File: grafana/provisioning/datasources/prometheus.yaml =====


apiVersion: 1
datasources:
  - name: Prometheus
    type: prometheus
    access: proxy
    url: http://prometheus:9090
    isDefault: true


# ===== File: templates/landing.html =====


<!doctype html>
<html lang="fa" dir="rtl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Landing</title>
    <style>
      body { font-family: sans-serif; margin: 0; background: #0b132b; color: #e0e0e0; }
      .hero { display: grid; place-items: center; min-height: 60vh; background: #1c2541; }
      .container { max-width: 640px; margin: 24px auto; padding: 16px; }
      .card { background: #243b55; padding: 16px; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,.3); }
      .row { display: flex; gap: 8px; }
      input { flex: 1; padding: 12px; font-size: 16px; border-radius: 6px; border: 1px solid #556; background: #0b132b; color: #e0e0e0; }
      button { padding: 12px 16px; font-size: 16px; border-radius: 6px; background: #00c2ff; color: #00111a; border: none; cursor: pointer; }
      button:disabled { opacity: .6; cursor: not-allowed; }
      .msg { margin-top: 12px; min-height: 20px; }
      .hero img { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    </style>
  </head>
  <body>
    <div class="hero">
      <div class="container">
        {% if minio_enabled %}
        <img src="{{ media_url }}hero-image.jpg" alt="Hero" onerror="this.src='https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?w=1200'" />
        {% else %}
        <img src="https://images.unsplash.com/photo-1496307042754-b4aa456c4a2d?w=1200" alt="Hero" />
        {% endif %}
      </div>
    </div>
    <div class="container">
      <div class="card">
        <h2>Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</h2>
        <div class="row">
          <input id="phone" inputmode="tel" placeholder="Ù…Ø«Ø§Ù„: 09121234567 ÛŒØ§ +989121234567" />
          <button id="submit">Ø«Ø¨Øª</button>
        </div>
        <div id="msg" class="msg"></div>
      </div>
    </div>

    <script>
      const phoneInput = document.getElementById('phone');
      const submitBtn = document.getElementById('submit');
      const msg = document.getElementById('msg');

      function setMessage(text, ok=true) {
        msg.textContent = text;
        msg.style.color = ok ? '#7CFC00' : '#ff6b6b';
      }

      async function submitPhone() {
        const phone = phoneInput.value.trim();
        submitBtn.disabled = true;
        setMessage('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„...');
        try {
          const res = await fetch('/api/submit', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone })
          });
          const data = await res.json();
          if (res.ok && data.ok) {
            setMessage(data.duplicate ? 'Ù‚Ø¨Ù„Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø¨ÙˆØ¯.' : 'Ø«Ø¨Øª Ø´Ø¯.');
            phoneInput.value = '';
          } else if (data.error === 'invalid_phone') {
            setMessage('Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.', false);
          } else if (data.error === 'rate_limited') {
            setMessage('Ø²ÛŒØ§Ø¯ÛŒ ØªÙ„Ø§Ø´ Ú©Ø±Ø¯ÛŒØ¯. Ø¨Ø¹Ø¯Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.', false);
          } else {
            setMessage('Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ.', false);
          }
        } catch (e) {
          setMessage('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡.', false);
        } finally {
          submitBtn.disabled = false;
        }
      }

      submitBtn.addEventListener('click', submitPhone);
      phoneInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') submitPhone();
      });
    </script>
  </body>
  </html>





# ===== File: manage.py =====


#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'config.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()


# ===== File: entrypoint.sh =====


#!/bin/bash
set -e

echo "Starting entrypoint script..."

# Function to wait for a service to be ready
wait_for_service() {
    local host=$1
    local port=$2
    local service=$3
    echo "Waiting for $service at $host:$port..."
    local count=0
    while ! nc -z $host $port; do
        sleep 1
        count=$((count + 1))
        if [ $count -gt 60 ]; then
            echo "ERROR: $service did not become available after 60 seconds"
            exit 1
        fi
    done
    echo "$service is ready!"
}

# Wait for services (only wait for what's needed)
if [ -z "$SKIP_WAIT" ]; then
    wait_for_service redis 6379 "Redis"
    
    # Worker needs DB for tasks that access models
    if [[ "$*" == *"celery worker"* ]]; then
        wait_for_service db 5432 "PostgreSQL"
        wait_for_service mongo 27017 "MongoDB"
    fi
    
    # Web service needs all services
    if [[ "$*" == *"gunicorn"* ]]; then
        wait_for_service db 5432 "PostgreSQL"
        wait_for_service mongo 27017 "MongoDB"
        wait_for_service minio 9000 "MinIO"
    fi
    
    echo "All required services are ready!"
fi

# Only run migrations and collectstatic for web service (gunicorn)
if [[ "$*" == *"gunicorn"* ]]; then
    echo "Making migrations..."
    python manage.py makemigrations --noinput || echo "No changes detected."

    echo "Running migrations..."
    python manage.py migrate --noinput
    
    echo "Collecting static files..."
    python manage.py collectstatic --noinput
    
    echo "Setting up MinIO bucket..."
    python manage.py setup_minio || echo "Warning: MinIO setup failed, continuing..."
    
    # Optionally upload sample media (set UPLOAD_SAMPLE_MEDIA=1 to enable)
    if [ "${UPLOAD_SAMPLE_MEDIA:-0}" = "1" ]; then
        echo "Uploading sample media to MinIO..."
        python manage.py upload_sample_media || echo "Warning: Sample media upload failed, continuing..."
    fi
fi

# Execute the main command
echo "Starting: $@"
exec "$@"



# ===== File: Dockerfile =====


FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

RUN apt-get update -y && apt-get install -y \
    build-essential \
    libpq-dev \
    netcat-openbsd \
    && rm -rf /var/lib/apt/lists/*

COPY requirements.txt /app/
RUN pip install --no-cache-dir -r requirements.txt

COPY . /app

# Copy the entrypoint script
COPY entrypoint.sh /app/entrypoint.sh

# Make entrypoint executable
RUN chmod +x /app/entrypoint.sh

# Set the environment variable
ENV DJANGO_SETTINGS_MODULE=config.settings

# Set the entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]

# Set the command
CMD ["gunicorn", "config.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "3"]





# ===== File: docker-compose.yml =====


services:
  web:
    build: .
    command: gunicorn config.wsgi:application --bind 0.0.0.0:8000 --workers 3
    env_file: .env
    environment:
      - DJANGO_SETTINGS_MODULE=config.settings
    volumes:
      - .:/app
    depends_on:
      - db
      - redis
      - mongo
      - minio
    ports:
      - "8000:8000"

  worker:
    build: .
    entrypoint: ["/app/entrypoint.sh"]
    command: celery -A config worker -l info
    env_file: .env
    volumes:
      - .:/app
    depends_on:
      - db
      - redis
      - mongo
      - minio

  beat:
    build: .
    entrypoint: ["/app/entrypoint.sh"]
    command: celery -A config beat -l info
    env_file: .env
    volumes:
      - .:/app
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  db:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=landing
      - POSTGRES_USER=landing
      - POSTGRES_PASSWORD=landing
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data

  mongo:
    image: mongo:6
    ports:
      - "27017:27017"
    volumes:
      - mongodata:/data/db

  minio:
    image: minio/minio:latest
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin
    volumes:
      - miniodata:/data
    ports:
      - "9000:9000"  # API port (needed for browser to access media files)
      - "9001:9001"  # Console port (web UI for managing files)

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web

  prometheus:
    image: prom/prometheus:latest
    command: --config.file=/etc/prometheus/prometheus.yml --web.listen-address=:9090
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
    ports:
      - "9090:9090"
    depends_on:
      - web

  grafana:
    image: grafana/grafana:latest
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
    volumes:
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards

  locust-master:
    image: locustio/locust:2.29.0
    ports:
      - "8089:8089"
    volumes:
      - ./locustfile.py:/mnt/locust/locustfile.py
    # Target Django app at http://web:8000 (Docker network)
    command: -f /mnt/locust/locustfile.py --master --host http://web:8000
    depends_on:
      - web

  locust-worker:
    image: locustio/locust:2.29.0
    volumes:
      - ./locustfile.py:/mnt/locust/locustfile.py
    command: -f /mnt/locust/locustfile.py --worker --master-host locust-master
    depends_on:
      - locust-master
    
volumes:
  pgdata:
  mongodata:
  miniodata:





# ===== File: nginx.conf =====


server {
    listen 80;
    server_name _;

    location /static/ {
        alias /app/static/;
        expires 7d;
    }

    location / {
        proxy_pass http://web:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}





# ===== File: requirements.txt =====


amqp==5.3.1
argon2-cffi==25.1.0
argon2-cffi-bindings==25.1.0
asgiref==3.10.0
attrs==25.4.0
bidict==0.23.1
billiard==4.2.2
blinker==1.9.0
boto3==1.34.34
botocore==1.34.162
brotli==1.2.0
celery==5.3.6
certifi==2025.10.5
cffi==2.0.0
charset-normalizer==3.4.4
click==8.3.0
click-didyoumean==0.3.1
click-plugins==1.1.1.2
click-repl==0.3.0
ConfigArgParse==1.7.1
Django==5.0.7
django-prometheus==2.3.1
django-redis==5.4.0
django-storages==1.14.2
djangorestframework==3.15.2
dnspython==2.8.0
drf-spectacular==0.27.2
Flask==3.1.2
flask-cors==6.0.1
Flask-Login==0.6.3
gevent==25.9.1
geventhttpclient==2.3.5
greenlet==3.2.4
gunicorn==21.2.0
h11==0.16.0
idna==3.11
inflection==0.5.1
iniconfig==2.3.0
itsdangerous==2.2.0
Jinja2==3.1.6
jmespath==1.0.1
jsonschema==4.25.1
jsonschema-specifications==2025.9.1
kombu==5.6.0
locust==2.42.2
locust-cloud==1.28.1
MarkupSafe==3.0.3
minio==7.2.3
msgpack==1.1.2
packaging==25.0
platformdirs==4.5.0
pluggy==1.6.0
prometheus_client==0.23.1
prompt_toolkit==3.0.52
psutil==7.1.3
psycopg2-binary==2.9.9
pycparser==2.23
pycryptodome==3.23.0
Pygments==2.19.2
pymongo==4.6.3
pytest==8.4.2
python-dateutil==2.9.0.post0
python-engineio==4.12.3
python-socketio==5.14.3
PyYAML==6.0.3
pyzmq==27.1.0
redis==5.0.1
referencing==0.37.0
requests==2.32.4
rpds-py==0.28.0
s3transfer==0.10.4
simple-websocket==1.1.0
six==1.17.0
sqlparse==0.5.3
typing_extensions==4.15.0
tzdata==2025.2
uritemplate==4.2.0
urllib3==2.5.0
uvicorn==0.30.1
vine==5.1.0
wcwidth==0.2.14
websocket-client==1.9.0
Werkzeug==3.1.3
whitenoise==6.7.0
wsproto==1.2.0
zope.event==6.1
zope.interface==8.0.1


# ===== File: prometheus.yml =====


global:
  scrape_interval: 5s

scrape_configs:
  - job_name: "django"
    metrics_path: /metrics
    static_configs:
      - targets: ["web:8000"]



# ===== File: README.md =====


# Landing Page (High Traffic) - Scenario 1

## Stack
- Django 5 (web)
- PostgreSQL (RDBMS for leads)
- Redis (broker/cache/idempotency)
- Celery (async worker)
- MongoDB (request logs)
- MinIO (object storage for media files - images/videos)
- Prometheus (metrics collection)
- Nginx (reverse proxy / static)

## Quick start (Docker)

1) Create `.env` next to this file (or copy `.env.example`):
```
DJANGO_DEBUG=1
DB_ENGINE=django.db.backends.postgresql
DB_NAME=landing
DB_USER=landing
DB_PASSWORD=landing
DB_HOST=db
DB_PORT=5432

REDIS_URL=redis://redis:6379/0
CELERY_BROKER_URL=redis://redis:6379/0
CELERY_RESULT_BACKEND=redis://redis:6379/0

MONGO_URI=mongodb://mongo:27017
MONGO_DB=landing_logs
MONGO_COLLECTION=requests

CACHE_BACKEND=django_redis.cache.RedisCache
CACHE_LOCATION=redis://redis:6379/1

# MinIO Settings
USE_MINIO=1
MINIO_ENDPOINT=minio:9000
MINIO_ACCESS_KEY=minioadmin
MINIO_SECRET_KEY=minioadmin
MINIO_BUCKET_NAME=landing-media
MINIO_USE_HTTPS=0
# Optional: Upload sample media on startup
UPLOAD_SAMPLE_MEDIA=0
```

2) Build & run:
```
docker compose up --build -d
```

**Note:** The entrypoint script automatically:
- Waits for all services (PostgreSQL, Redis, MongoDB, MinIO)
- Runs database migrations
- Collects static files
- Sets up MinIO bucket
- Optionally uploads sample media (if `UPLOAD_SAMPLE_MEDIA=1`)

3) Open:
- App (via Nginx): http://localhost/
- App (direct): http://localhost:8080/
- Health: http://localhost:8080/healthz
- Metrics: http://localhost:8080/metrics/
- API schema: http://localhost:8080/api/schema/
- Swagger UI: http://localhost:8080/api/docs/
- Redoc: http://localhost:8080/api/redoc/
- Admin: http://localhost:8080/admin
- Prometheus UI: http://localhost:9090/

**Note:** Internal services (Redis, PostgreSQL, MongoDB, MinIO) are only accessible within Docker network. To access them from host, uncomment port mappings in `docker-compose.yml`.

**MinIO Console:** Visit http://localhost:9001 (default credentials: minioadmin/minioadmin).

**Prometheus:** Visit http://localhost:9090 to explore collected metrics (scrapes `/metrics/` from the Django service).

**OpenAPI / Swagger:**
- JSON schema: `python manage.py spectacular --file schema/openapi.json`
- YAML schema: `python manage.py spectacular --format yaml --file schema/openapi.yaml`
- Interactive docs: `/api/docs/` (Swagger UI) and `/api/redoc/` (ReDoc)

## Local without Docker (dev)
```
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
export DJANGO_SETTINGS_MODULE=config.settings
python manage.py migrate
python manage.py runserver 0.0.0.0:8000
```

## API
- POST `/api/submit` JSON `{ "phone": "0912..." }`
  - 202 Accepted on queue (duplicate=false)
  - 200 OK if duplicate within 24h
  - 400 invalid phone, 429 rate limited

## MinIO / Media Files

Media files (images/videos for landing page) are stored in MinIO. To upload files:

1. Access MinIO console (uncomment port 9001 in docker-compose.yml)
2. Or use the management command:
   ```bash
   docker compose exec web python manage.py upload_sample_media
   ```

The landing page template automatically loads images from MinIO if available, with fallback to external URLs.

## Notes
- **Automatic Setup:** Entrypoint handles migrations, static collection, MinIO bucket setup, and exposes Prometheus metrics automatically
- **Async:** Request enqueues Celery tasks and returns immediately
- **Durability:** Redis broker keeps tasks until processed; DB writes happen in worker
- **Idempotency:** Redis SETNX per phone for 24h
- **Logging:** MongoDB stores `{ip, ua, phone, duplicate, ts}`
- **Caching:** Landing page cached 60s; Nginx serves static
- **Storage:** Media files (images/videos) stored in MinIO object storage
- **Monitoring:** Prometheus scrapes `/metrics/`; integrate with Grafana or alerting as needed
- **Security:** Validation, throttling; run behind Nginx; keep DEBUG=0 in prod





# ===== File: ARCHITECTURE.md =====


# Architecture - Scenario 1 (High-traffic Landing)

## Goals
- 100% durability of submissions under heavy load
- Sub-second page load; immediate user feedback on submit
- Polyglot persistence: PostgreSQL for leads, MongoDB for logs
- Horizontal scalability with containers

## Components
- Django (web): serves landing page and `/api/submit`
- Celery + Redis: async queue for durable background processing
- PostgreSQL: persistent storage for leads
- MongoDB: append-only request logs (timestamp, UA, IP, etc.)
- Nginx: reverse proxy and static delivery

## Flow (Submit)
1. Client POSTs `{phone}` to `/api/submit`
2. Server validates phone, throttles by IP
3. Idempotency via Redis `SETNX dedup:phone:{phone}` TTL 24h
   - If exists: return 200 immediately (`duplicate=true`)
4. Enqueue `persist_lead_task(phone, ip, ua)` to Celery (Redis broker)
5. Enqueue `log_request_task(meta)` to MongoDB
6. Respond 202 immediately (no DB wait)

## Durability
- Redis (AOF) retains tasks until acked by worker; retries on failure
- DB writes run in worker processes, isolated from web latency spikes

## Performance
- Landing HTML cached 60s (Django) + static via Nginx
- Minimal synchronous logic on submit; everything heavy is async

## Security
- Input validation (regex) and per-IP rate limiting
- Run behind Nginx; disable DEBUG in production
- CSRF is exempt only for the JSON API endpoint

## Deployment
- Dockerized services: web, worker, beat, redis, postgres, mongo, nginx
- `.env` controls connections; switchable to managed services in prod

## Observability
- `/healthz` endpoint for container/ELB health checks
- MongoDB contains raw request logs for audit/BI





# ===== File: LICENSE =====


MIT License

Copyright (c) 2025 Soroushk1999

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
